---
layout: post
title: IFT6758 Milestone 1
---

Dans cette première étape de notre projet, nous nous concentrons sur la manipulation des données et l’analyse exploratoire. Travailler avec des données de la LNH, en particulier des statistiques "play-by-play", nous permet de comprendre les défis de la science des données dans un environnement réel. Ce blog va résumer les principales tâches et découvertes effectuées au cours de cette étape.

## 1: Acquisition de données
Nous avons utilisé l'API de statistiques de la LNH pour récupérer les données agrégées des joueurs ainsi que les données "play-by-play". Le processus d’acquisition de ces données a nécessité la création d’une fonction en Python qui interroge l'API, télécharge les données, puis les sauvegarde localement pour une utilisation ultérieure.

Dans cette démarche, une **API REST** est exploitée pour :

1. Télécharger les données play-by-play de la LNH par match en utilisant l'identifiant du match.
2. Télécharger les données des saisons régulières pour une plage définie.
3. Télécharger les données des playoffs pour une plage définie.
4. Fusionner ces données dans un répertoire commun pour des analyses futures.

## Qu'est-ce qu'un game_id ?

Les données de chaque match sont sauvegardées dans des fichiers JSON, identifiés par un `game_id`. Comprendre la structure de ce `game_id` est crucial pour accéder et sauvegarder les données localement. Le `game_id` est un code à 10 chiffres qui varie selon la saison régulière ou les playoffs :

- **Saison régulière** : Les 4 premiers chiffres représentent l'année (par exemple, 2016 pour la saison 2016-2017), les 2 chiffres suivants indiquent le type de match (02 pour saison régulière), et les 4 derniers correspondent au numéro du match.
- **Playoffs** : Le `game_id` est organisé par rounds et confrontations sous la forme `"{year_str}0301{matchup}{game_number}"`, où `matchup` représente le numéro de la confrontation entre deux équipes, et `game_number` correspond au numéro du match (de 1 à 7).

Pour plus de détails sur la formation du `game_id`, consultez [ce lien](https://gitlab.com/dword4/nhlapi/-/blob/master/stats-api.md#game-ids).

## Pourquoi utiliser une API REST pour ce projet ?

Une **API REST** permet une communication efficace entre différents systèmes. Voici ses avantages :

1. **Accès structuré aux données** : Elle offre un accès cohérent aux informations sur les matchs, joueurs, statistiques, etc.
2. **Flexibilité et scalabilité** : L’API permet d’accéder à des données spécifiques, par exemple les matchs d’une saison donnée, rendant le processus flexible.
3. **Mises à jour en temps réel** : L'API offre les données les plus récentes, garantissant que les informations ne sont jamais obsolètes.
4. **Facilité d'intégration** : Accessible via des requêtes HTTP simples, elle s'intègre facilement dans divers langages de programmation.

## Création de répertoires de sauvegarde locaux

Pour optimiser l’acquisition des données, nous définissons trois répertoires de sauvegarde locaux : un pour les saisons régulières, un pour les playoffs, et un pour l’ensemble des données. Cela réduit les requêtes répétées à l'API, augmentant ainsi l'efficacité.

## Utilisation d'une classe pour télécharger les données

La meilleure approche consiste à créer une **classe** [Figure 01](#figure-01) encapsulant la logique de téléchargement et de sauvegarde des données. Par exemple, la classe `NHLDataDownloader` télécharge et sauvegarde les données en fonction du `game_id` en format JSON. Son constructeur accepte le chemin du répertoire de stockage, et la fonction `download_game_data` télécharge les données si elles ne sont pas déjà présentes localement.

![NHL Class](public/images/nhldownloader.png)

<figcaption id="figure-01">_Figure 01 : NHLDataDownloader Class._</figcaption>

## Téléchargement des matchs des saisons régulières  de 2016 à 2023:

Le constructeur utilisé pour télécharger les données de chaque match est d'abord appelé pour définir le répertoire de stockage des données des saisons régulières. 
La fonction download_all_seasons prend en paramètres deux arguments : start_year et end_year, correspondant à la plage d'années souhaitée. La logique principale consiste ensuite à générer les identifiants des matchs `(game_id)` en itérant sur chaque année de cette plage et sur les numéros des matchs associés. Il est important de noter que le nombre total de matchs par saison `(no_of_games)` peut varier. Le `game_id` est généré comme suit :

 `game_id = f"{year_str}02{str(game_number).zfill(4)}"`
Ensuite, la méthode download_game_data est appelée pour chaque game_id généré afin de télécharger et stocker les données des matchs de la LNH sous forme de fichiers JSON dans le répertoire data/nhl_reguliere2.

Le code correspondant à cette partie est illustré dans la [Figure 02](#figure-02) suivante:

![NHL Class](public/images/download_all_seasons.png)

<figcaption id="figure-02">_Figure 02 : Téléchargement des matchs des saisons régulières._</figcaption>

## Téléchargement des matchs des des playoffs de 2016 à 2023:
La fonction `download_playoffs_data` fonctionne de manière similaire à la fonction `download_all_seasons`, utilisée pour les saisons régulières. La différence principale réside dans la méthode de génération du `game_id` pour les playoffs, ainsi que le stockage des fichiers JSON dans le répertoire `data/nhl_playoffs2`.

Pour les playoffs, le `game_id` est généré en tenant compte du round (1/8 de finale, 1/4 de finale, etc.) et des confrontations entre équipes. Voici comment le game_id est créé pour les 1/8 de finale (round 01):

 `playoffs.extend([f"{year_str}0301{str(matchup)}{game_number}" for matchup in range(1, 9) for game_number in range(1, 8)])`


Les valeurs du paramètre matchup (numéros des confrontations) dépendent du round (1/8 de finale, 1/4 de finale, etc.), et le nombre de valeurs possibles pour game_number ne peut pas dépasser 7 (un maximum de 7 matchs par série). Le code est illustré dans la [Figure 03](#figure-03) suivante:

![NHL Class](public/images/download_playoffs_data.png)
<figcaption id="figure-03">_Figure 03 : Téléchargement des matchs des playoffs._</figcaption>


## Fusion des deux repertoires data/nhl_reguliere2 et data/nhl_playoffs2 dans data/nhl_data
Cette étape consiste à stocker les données des saisons régulières et des playoffs dans un fichier unique, data/nhl_data. Le code ainsi que son exécution sont détaillés ci-dessous [Figure 04](#figure-04).

![fusion data](public/images/fusion.png)

<figcaption id="figure-04">_Figure 04 : Fusion des repertoire._</figcaption>

On voit que ci-dessous [Figure 05](#figure-05) que le fichier data/nhl_data contient à la fois les fichiers json des saisons régulières (code 02) et celui des playoffs (code 03).

![fusion data1](public/images/fusion1.png)

<figcaption id="figure-05">_Figure 05 : Resultat de fusion._</figcaption>

## Gestion des erreurs :
La gestion des erreurs, telles que les requêtes échouées ou les problèmes de connexion, a été soigneusement prise en compte. Pour éviter de surcharger le serveur, un délai a été ajouté entre chaque requête :

`except Exception as e:` 
`print(f"Erreur de téléchargement pour le match {game_id}: {e}")`
`time.sleep(1)  # Pause d'une seconde entre les requêtes`

Les erreurs de téléchargement sont également gérées pour les saisons régulières et les playoffs. Après chaque tentative de téléchargement, le programme vérifie si les données ont été correctement récupérées :

`if game_data:`
    `print(f"Données pour le game_id {game_id} téléchargées avec succès.")`
`else:`
    `print(f"Aucune donnée disponible pour le game_id {game_id}.")`

## 2: Outils de débogage interactif

## Description de l'outil

Cet outil interactif offre une exploration approfondie de tous les événements d'une saison donnée de la LNH. Il permet de naviguer aisément entre la saison régulière et les séries éliminatoires, de sélectionner un match spécifique, puis d'examiner chaque événement un à un. Les événements dotés de coordonnées sont visualisés sur une patinoire, tandis que les événements sans coordonnées affichent directement les informations pertinentes.

L'outil fournit également des détails supplémentaires, tels que le type d'événement et le moment où il survient dans la période. Grâce à cette interface, l'utilisateur peut :

- Choisir la saison à l'aide du premier curseur.
- Basculer entre les modes saison régulière et séries éliminatoires grâce à des boutons de navigation.
- Sélectionner un match spécifique à l'aide du deuxième curseur.
- Parcourir les événements du match choisi avec un troisième curseur.

Le code met à jour les informations sélectionnées en temps réel et affiche le résultat directement à l'écran, offrant ainsi une expérience de débogage fluide et visuelle.

### Exemple de résultat

La figure ci-dessous [Figure 06](#figure-06) illustre le résultat de l'outil interactif pour l'événement 251 du match dont l'ID est `2019030312`, appartenant aux séries éliminatoires. Comme cet événement inclut des coordonnées `x` et `y`, celles-ci sont représentées visuellement sur la patinoire.

![outil interactif](public/images/outil_interactif.jpeg)

<figcaption id="figure-06">_Figure 06 : Visualisation des coordonnées et des informations détaillées pour l'événement 251 du match avec l'ID 2019030312, dans l'outil interactif._</figcaption>


## Logique générale du déboggeur:

Le code implémente un débogueur interactif qui comporte une interface 
permettant de naviguer dans différents événements, saisons et types de jeux.

### 1. Initialisation des variables **(`__init__`)** :

```
 * Le debébogueur est instancié
 * Les données du jeu sont chargées
 * Certaines variables sont définies pour gérer les informations sur la saison:
 * Le type de jeu: _saison régulière ou playoffs_
 * L'ID du jeu
 * L'événement en cours
 * Les widgets _(curseurs, boutons de bascule, etc.)_ sont initialisés pour 
permettre à l'utilisateur de sélectionner:
 * La saison
 * Le type de jeu
 * L'ID du match
 * L'événement spécifique à afficher
```
### 2. Widgets interactifs:

```
* Slider de saison: _Permet de sélectionner la saison à explorer._
* Boutons de bascule: _Permettent de basculer entre les matchs de la saison 
régulière et les matchs des playoffs._
* Slider d'ID de match: _Permet de sélectionner un match spécifique dans la 
saison._
* Slider d'événement: _Permet de parcourir les événements d'un match. Par 
exemple: tirs, face-offs, buts_.
```

### 3. Fonction **season_range()**:

```
* Cette fonction parcourt les fichiers JSON du répertoire pour déterminer la saison 
minimale et maximale disponibles dans les données.
* Renvoie une plage de saisons permettant d'ajuster dynamiquement le slider de 
saison.
```
### 4. Affichage des coordonnées de l'événement **(plot_coordinates())**:

```
Affiche les coordonnées d'un événement (par exemple, un tir) sur une image d'une 
patinoire, si les coordonnées sont disponibles. Utilise matplotlib pour superposer 
les coordonnées sur l'image de la patinoire.
```

### 5. Affichage des informations du jeu et de l'événement **(display_info())**:

```
Affiche des détails tels que l'ID du match, les équipes participantes, la date du 
match, le score final, le nombre d'événements et la description de l'événement 
actuel.
Inclut également le nom du stade et la ville où se déroule le match, ainsi que des 
détails sur l'événement (période, temps écoulé).
```
### 6. Filtrage des données **filter_season()** et **filter_playoffs()**:

```
* filter_season(): _Filtre les jeux en fonction de la saison sélectionnée par 
l'utilisateur._
* filter_playoffs(): _Filtre les jeux en fonction du type de jeu sélectionné (saison 
régulière ou playoffs)._
```
### 7. Mise à jour des variables du jeu et de l'événement **update_vars()**:

```
Met à jour les variables qui contiennent des informations sur le jeu en cours et 
l'événement sélectionné.
Cela inclut la mise à jour des informations sur les équipes, le score, le stade, la 
ville, les coordonnées de l'événement, la description, et d'autres détails 
pertinents.
```

### 8. Mise à jour dynamique via widgets **update`_*`()**:

```
Ces fonctions sont déclenchées à chaque fois que l'utilisateur modifie un widget. 
Elles mettent à jour la saison, le type de jeu, l'ID du jeu ou l'événement, et 
actualisent les informations affichées :
* update_season(): _Met à jour les jeux en fonction de la saison choisie._
* update_game_type(): _Met à jour les jeux en fonction du type de jeu (Playoffs ou 
Saison régulière)._
* update_game_id(): _Met à jour les informations pour l'ID du jeu sélectionné._
* update_event(): _Met à jour les informations pour l'événement sélectionné dans 
le jeu._
```

### 9. Affichage final **display_output()**:

```
La fonction display_output() permet de rendre visible le widget interactif, en 
affichant toutes les informations mises à jour en fonction des sélections faites par 
l'utilisateur
```

## 3: Nettoyage et organisation des données
## 3.1 Extrait du DataFrame final
Pour ce projet, nous avons nettoyé les données brutes de la LNH en nous concentrant uniquement sur les événements pertinents. Les types d'événements disponibles dans les données comprennent : ['blocked-shot', 'delayed-penalty', 'faceoff', 'failed-shot-attempt', 'game-end', 'giveaway', 'goal', 'hit', 'missed-shot', 'penalty', 'period-end', 'period-start', 'shootout-complete', 'shot-on-goal', 'stoppage', 'takeaway'].

Cependant, seuls deux événements sont d'intérêt pour notre analyse : goal et shot-on-goal. Nous avons donc filtré le DataFrame pour ne conserver que ces types d'événements. De plus, les identifiants des tireurs (shooter) et des gardiens de but (goalie) ont été transformés en noms et prénoms à l'aide d'une fonction de correspondance basée sur le champ rosterSpots des fichiers JSON.

Les données nettoyées ont ensuite été intégrées dans un DataFrame pandas final, comme illustré ci-dessous [Figure 07](#figure-07). Voici un aperçu des 10 premières lignes de ce DataFrame après extraction et traitement des événements de jeu, incluant les tirs et les buts :

![df_nettoyage](public/images/df_nettoyage.png)

<figcaption id="figure-07">_Figure 07 :DataFrame Final nettoyée._</figcaption>

Ce DataFrame comprend les colonnes suivantes, essentielles pour les analyses futures :

`columns = [
    'gameId', 'season', 'teamHome', 'teamAway', 'eventType', 'eventTeam', 
    'period', 'periodTime', 'coordinateX', 'coordinateY', 'shooterName', 
    'goalieName', 'shotType', 'emptyNet', 'strength'
]`
## 3.2 Extraction de l'information sur la force réelle
Pour les événements de type goal, l'information concernant la force réelle des équipe est directement disponible dans le champ `situationCode` du fichier JSON. Ce code est composé de quatre chiffres qui décrivent la situation comme suit :

away goalie-home goalie-away skaters-home skaters :
Le premier chiffre représente l’état du filet de l’équipe à l’extérieur (1 : gardien présent, 0 : filet vide).
Le second chiffre représente l’état du filet de l’équipe à domicile.
Les deux derniers chiffres représentent le nombre de joueurs sur la glace pour les équipes extérieure et à domicile, respectivement.

Voici un extrait du code implémentant le calcul de la force:
```
if event_team_id == self.data['awayTeam']['id']:
    # Équipe extérieure effectue l'événement
    if away_skaters > home_skaters:
        strength = "PP"  # Avantage numérique (Power Play)
    elif away_skaters < home_skaters:
        strength = "SH"  # Désavantage numérique (Short-Handed)
    else:
        strength = "EV"  # Forces égales
elif event_team_id == self.data['homeTeam']['id']:
    # Équipe à domicile effectue l'événement
    if home_skaters > away_skaters:
        strength = "PP"  # Avantage numérique pour l'équipe à domicile
    elif home_skaters < away_skaters:
        strength = "SH"  # Désavantage numérique
    else:
        strength = "EV"  # Forces égales
else:
    strength = None  # Cas non traité
```
Pour les tirs, cette information n’est pas directement disponible via le champ situationCode. Afin d'ajouter cette information, il est possible de corréler les tirs avec d'autres événements tels que les pénalités, les changements de ligne, ou les retraits de gardien, pour reconstruire la situation exacte de chaque équipe sur la glace.

Exemple d'utilisation des pénalités
Les événements de pénalités fournissent des informations cruciales, telles que :

Le moment de la pénalité.
Le joueur et l’équipe sanctionnée.
Le type de pénalité (par exemple, "Mineure").
Ces informations permettent de déterminer combien de joueurs sont sur la glace à un instant donné et de calculer l’avantage ou désavantage numérique des équipes pendant la durée de la pénalité.

## 3.3 Création de nouvelles caractéristiques:
Nous avons identifié plusieurs caractéristiques supplémentaires qui peuvent être dérivées des données disponibles dans les fichiers JSON ou d'autres sources :

- **a. Rebondissement  :** Un tir est considéré comme un rebond si un second tir est effectué peu de temps après un arrêt du gardien, sans que le palet ait quitté la zone offensive. Cela nécessite une analyse chronologique et spatiale des événements de tir.

- **b. Informations supplémentaires sur les joueurs et équipes :** Nous pourrions intégrer des données supplémentaires sur les joueurs, telles que leur âge, taille, poids, ou poste (centre, ailier, défenseur), qui pourraient avoir un impact sur leurs performances.

- **c. Tirs en contre-attaque :** Ces tirs peuvent être identifiés si un événement de changement de possession (par exemple, giveaway ou takeaway) précède immédiatement un tir dans la zone défensive de l'adversaire.

- **d. Caractéristiques spatiales et temporelles :** Nous pourrions exploiter les coordonnées xCoord et yCoord ainsi que le temps (periodTime) pour identifier les zones de la patinoire où les événements se produisent, ainsi que leur fréquence selon les périodes. [Figure 08](#figure-08)

![d](public/images/d.png)
<figcaption id="figure-08">_Figure 08 : Caractéristiques spatiales et temporelles._</figcaption>

- **e. Blocages et déviations :** Il serait pertinent de suivre les tirs qui sont bloqués ou déviés avant d'atteindre le but. Ces événements peuvent être extraits à partir des événements de type blocked-shot et missed-shot, en analysant les coordonnées du tir pour déterminer s'ils ont été déviés ou non.

## 4: Visualisations simples des données
## 4.1 Comparaison des types de tirs pour toutes les équipes
our cette analyse, nous avons produit un graphique comparant les différents types de tirs réalisés par toutes les équipes au cours d'une saison spécifique. Le nombre de buts est superposé au nombre de tirs pour chaque type. Ce graphique permet d'identifier les types de tirs les plus fréquents ainsi que ceux qui sont les plus efficaces.

Nous avons opté pour un **diagramme à barres (Barplot)** pour cette visualisation, car il est particulièrement adapté à la comparaison de différentes catégories de données. Voici les raisons principales de ce choix :

1. **Clarté et simplicité** : il est facile à comprendre et à interpréter. Il permet de visualiser immédiatement les différences entre les catégories à travers la longueur des barres, représentant le nombre de tirs et de buts par type de tir.

2. **Comparaison entre catégories** :il facilite la comparaison entre plusieurs catégories, ce qui est essentiel pour identifier quel type de tir est le plus courant ou le plus efficace.

3. **Affichage de tendances** : Ce type de graphique met en évidence les tendances générales et les différences importantes entre les types de tirs, permettant de repérer les écarts significatifs.

4. **Adapté aux données catégoriques** : Les barplots sont parfaits pour les données catégoriques comme les types de tirs, qui ne suivent pas une échelle continue.

5. **Comparaison de groupes multiples** : Grâce à l’utilisation de barres groupées, nous pouvons comparer le nombre de tirs et de buts simultanément, facilitant ainsi l’analyse des types de tirs les plus performants.

6. **Visualisation d’écarts importants** : Les barplots permettent de détecter rapidement les types de tirs qui se démarquent, en soulignant les écarts importants dans le nombre de tirs et de buts.

Ci-dessous, le graphique [Figure 09](#figure-09) présente le nombre de tirs et de buts pour chaque type de tir, agrégé pour toutes les équipes durant la saison 2022-2023 :

![Comparaison des tirs](public/images/barplot_cmpr.png)

<figcaption id="figure-09">_Figure 09 :  Représentation du nombre de tirs et de buts pour chaque type de tir, agrégé pour toutes les équipes durant la saison 2022-2023._</figcaption>
- **Tir le plus courant** : Le type de tir le plus courant est le **tir du poignet (wrist)**, comme le montre la hauteur de la barre qui est la plus élevée.
- **Tir le plus dangereux** : En se basant sur le taux de conversion en buts, le tir **"deflected"** semble être le plus dangereux, suivi de près par le **"tip-in"**.

Cependant, en raison des différences de magnitude entre les types de tirs, certaines catégories sont difficilement visibles. Pour surmonter ce problème, nous avons utilisé une **échelle logarithmique** sur l'axe des ordonnées afin de mieux visualiser les variations [Figure 10](#figure-10):

![Barplot avec échelle logarithmique](public/images/barplot_log_scale.png)
<figcaption id="figure-10">_Figure 10 : visualisation des types de tirs avec échelle logarithmique sur l’axe des ordonnées._ </figcaption>


Avec cette échelle, il apparaît que le type de tir le plus dangereux reste le **tir "deflected"**, mais d'autres types de tirs tels que le **"cradle"** deviennent également visibles. Ces observations sont confirmées par le calcul de la proportionnalité des buts par type de tir.

## 4.2 Relation entre la distance de tir et le succès de marquage
Nous avons également examiné la relation entre la distance à laquelle un tir est effectué et la probabilité qu'il soit transformé en but. Pour cela, nous avons produit des graphiques pour chaque saison de 2018-19 à 2020-21.

Nous avons choisi le **nuage de points (scatterplot)** pour cette analyse, car il permet de visualiser la relation entre deux variables continues : la distance du tir et la probabilité de marquer un but. Les avantages de ce choix incluent :

- **Visualisation de la relation entre les variables** : Un scatterplot montre clairement s'il existe une corrélation entre la distance et la probabilité de marquer.
- **Visualisation de la dispersion des données** : Ce graphique met en évidence les tendances générales et les valeurs aberrantes (outliers).
- **Identification des zones clés** : Les zones où les points se concentrent peuvent indiquer les distances où les buts sont les plus fréquents.

### Méthode de calcul de la distance

La distance est une métrique clé que nous devons évaluer à partir des données disponibles dans les fichiers JSON ou les DataFrames. En fonction des saisons, le calcul de la distance varie, soit en utilisant le champ `zoneCode` dans le sous-champ `details` de `plays`, soit en exploitant le champ `homeTeamDefendingSide` présent dans `plays`.

#### Saisons 2016-2017, 2017-2018 et 2018-2019
Pour ces saisons, le calcul de la distance repose sur le champ `zoneCode`, qui détermine trois zones possibles : la zone défensive (`D`), la zone offensive (`O`) et la zone neutre (`N`).

- **Zone défensive (D)** : Les distances des filets sont plus grandes. Si l'abscisse `x` est positive, la distance est calculée comme suit :  
  \[
  d = \sqrt{(x + 89)^2 + y^2}
  \]  
  Si `x` est négatif, la formule devient :  
  \[
  d = \sqrt{(89 - x)^2 + y^2}
  \]

- **Zone offensive (O)** : Le calcul est inversé par rapport à la zone défensive, car les distances sont plus petites en direction du filet adverse.

- **Zone neutre (N)** : Dans cette zone, il est nécessaire de vérifier si `eventOwnerTeamId` correspond à l’équipe à domicile (`home_team`) et de prendre en compte le côté défensif de cette équipe pendant la période (`homeTeamDefendingSide`).  
  - Si `homeTeamDefendingSide = 'right'`, la distance est calculée comme :  
    \[
    d = \sqrt{(x + 89)^2 + y^2}
    \]
  - Si `homeTeamDefendingSide = 'left'`, la formule devient :  
    \[
    d = \sqrt{(89 - x)^2 + y^2}
    \]

Si `eventOwnerTeamId` correspond à l'équipe visiteuse (`away_team`), le raisonnement s'inverse en fonction de la position du filet.

Note : Les coordonnées `(89, 0)` et `(-89, 0)` correspondent respectivement aux positions des filets des deux équipes.

#### Calcul de la distance pour les autres saisons

Pour les autres saisons, le calcul de la distance est basé sur les champs `homeTeamDefendingSide`, `eventOwnerTeamId` et `homeTeamId`. Le processus consiste à comparer la valeur de `eventOwnerTeamId` (notamment pour un événement de type `goal`, indiquant l’équipe ayant marqué) avec celle de `homeTeamId`.

- **Cas où `eventOwnerTeamId = homeTeamId`**  
  Si l’équipe à domicile est à l’origine de l’événement, la distance est calculée en fonction de `homeTeamDefendingSide`.  
  - Si `homeTeamDefendingSide = 'right'`, cela signifie que le but est marqué dans le camp gauche de l'adversaire, et la distance est :  
    \[
    d = \sqrt{(x + 89)^2 + y^2}
    \]
    avec `(-89, 0)` représentant les coordonnées des filets adverses à gauche.  
  - Si `homeTeamDefendingSide = 'left'`, le calcul s’inverse et devient :  
    \[
    d = \sqrt{(89 - x)^2 + y^2}
    \]
    avec `(89, 0)` pour les filets adverses à droite.

- **Cas où `eventOwnerTeamId ≠ homeTeamId` (donc égal à `awayTeamId`)**  
  Si l'équipe ayant marqué est l'équipe visiteuse, la logique s’inverse de manière similaire.

### Implémentation du calcul

Le programme implémentant cette logique est détaillé ci-dessous, prenant en compte les différentes saisons et zones pour un calcul précis de la distance des tirs en fonction de la position du joueur et de l’équipe.



### **Implémentation**

Le programme qui implémente cette logique prend en compte les différentes zones et définitions du champ `homeTeamDefendingSide`, garantissant ainsi un calcul précis de la distance pour chaque événement. Voici le code correspondant :
```
import math

def calculate_distance(row, home_team_id, away_team_id, season):
    # Extraire les coordonnées
    x = row['xCoord']
    y = row['yCoord']
    event_team_id = row['eventOwnerTeamId']
    defending_side = row.get('homeTeamDefendingSide', None)
    zone_code = row.get('zoneCode', None)
    
    # Initialiser la liste de distances pour stocker les distances calculées
    distances = []
    home_defending_side_period = {1: None, 2: None, 3: None}
    
    # Vérifier si l'équipe est à domicile ou à l'extérieur
    # Check season and set calculation conditions
    for index, row in df_season.iterrows():
        # Initialiser la distance à None pour chaque ligne
        distance = None

        # Extraire les informations pertinentes
        x = row['coordinateX']
        y = row['coordinateY']
        event_team_id = row['eventTeamId']

        home_team_id = row['teamHomeId']
        defending_side = row.get('homeTeamDefendingSide', None)
        zone_code = row.get('zoneCode', None)
        period = row.get('period', None)

        # Vérifier la saison et définir les conditions de calcul
        if season in [20161017, 20172018, 20182019] and zone_code is not None:
            # Utiliser zone_code pour ces saisons spécifiques
            if event_team_id == home_team_id and period in home_defending_side_period:
                # Vérifier si le côté défensif pour cette période est déjà défini
                if home_defending_side_period[period] is None:
                    # Déterminer le côté défensif en fonction de la valeur de xCoord
                    home_defending_side_period[period] = 'right' if x > 0 else 'left'

            # Calculer la distance en fonction du zone_code
            if zone_code == "D":
                if x > 0:
                    distance = math.sqrt((x + 89)**2 + y**2)
                elif x < 0:
                    distance = math.sqrt((89 - x)**2 + y**2)
            elif zone_code == "O":
                if x > 0:
                    distance = math.sqrt((89 - x)**2 + y**2)
                elif x < 0:
                    distance = math.sqrt((x + 89)**2 + y**2)
            elif zone_code == "N" and period in home_defending_side_period:
                if event_team_id == home_team_id:
                    if home_defending_side_period[period] == 'right':
                        distance = math.sqrt((x + 89)**2 + y**2)
                    elif home_defending_side_period[period] == 'left':
                        distance = math.sqrt((89 - x)**2 + y**2)
                else:
                    if home_defending_side_period[period] == 'right':
                        distance = math.sqrt((89 - x)**2 + y**2)
                    elif home_defending_side_period[period] == 'left':
                        distance = math.sqrt((x + 89)**2 + y**2)
        else:
            # Utiliser homeTeamDefendingSide pour les autres saisons
            if event_team_id == home_team_id:
                if defending_side == "right":
                    distance = math.sqrt((x + 89)**2 + y**2)
                elif defending_side == "left":
                    distance = math.sqrt((89 - x)**2 + y**2)
            else:
                if defending_side == "right":
                    distance = math.sqrt((89 - x)**2 + y**2)
                elif defending_side == "left":
                    distance = math.sqrt((x + 89)**2 + y**2)

        # Ajouter la distance calculée à la liste
        distances.append(distance)

    return distance
```
Nous avons opté pour l'utilisation de **nuages de points** (ou **scatterplots**) pour représenter ces données, car ce type de graphique est idéal pour illustrer la relation entre deux variables continues, en l'occurrence la distance des tirs par rapport au but et le pourcentage de réussite (buts marqués). Cette visualisation permet de détecter d'éventuelles corrélations entre la distance de tir et la probabilité de marquer un but.

Le scatterplot met en évidence la **dispersion des données**, ce qui facilite l'identification de **tendances générales** ainsi que de **valeurs atypiques** ou **outliers**. Lorsque certains points se regroupent à des distances spécifiques, cela peut révéler des zones où les buts sont plus fréquents. Contrairement à une courbe linéaire, le scatterplot offre une meilleure compréhension de la répartition des tirs, en particulier pour les distances supérieures à 100 pieds, où la variabilité est plus importante.

Les graphiques [Figure 11](#figure-11), [Figure 12](#figure-12) , [Figure 13](#figure-13), ci-dessous illustrent cette analyse pour différentes saisons :

![Scatterplot saison 2018-19](public/images/4.2.1.png)
<figcaption id="figure-11">_Figure 11 : Scatterplot :  Pourcentage de buts en fonction de la distance (Saison 2018-2019)_ </figcaption>


![Scatterplot saison 2019-20](public/images/4.2.2.png)
<figcaption id="figure-12">_Figure 12 : Scatterplot : Pourcentage de buts en fonction de la distance (Saison 2019-2020)_ </figcaption>

![Scatterplot saison 2020-21](public/images/4.2.3.png)
<figcaption id="figure-13">_Figure 13: Scatterplot :  Pourcentage de buts en fonction de la distance (Saison 2020-2021)_ </figcaption>


- **Proximité du filet et efficacité** : Les figures montrent que la majorité des buts sont marqués à des distances très proches du filet (proches de 0 pied), en particulier lorsque l’équipe adverse parvient à s'approcher du but. Toutefois, on constate que le pourcentage de ces buts diminue au fil des saisons, ce qui pourrait refléter une **amélioration des capacités défensives** des équipes adverses.

- **Distances moyennes (25-75 pieds)** : Pour les distances comprises entre 25 et 75 pieds, le comportement semble être relativement similaire d'une saison à l'autre. Le pourcentage de buts diminue progressivement à mesure que la distance augmente, pour devenir presque négligeable aux alentours de 75 pieds.

- **Saison 2018-2019 : particularités**  
  Une particularité notable de la saison 2018-2019 est l'absence totale de tentatives de marquage à certaines distances, comme entre 70 et 85 pieds ou encore entre 95 et 115 pieds.

- **Longues distances (125-175 pieds)** : Dans toutes les saisons, il existe des buts marqués à des distances considérables, entre 125 et 175 pieds, avec des pourcentages de réussite supérieurs à ceux observés entre 50 et 75 pieds. Cette situation est souvent attribuée à l'absence du gardien de but dans les bois, une condition qui augmente les chances de marquer.

- **Évolution au fil des saisons** : La **saison 2019-2020** montre une distribution plus uniforme des pourcentages dans la plage [125, 175 pieds], tandis que la **saison 2020-2021** affiche une plus grande densité de tirs réussis dans cette même plage. 

- **Pic au-delà de 175 pieds** : Un **pic** notable est observé au-delà de 175 pieds lors de la saison 2019-2020. Il pourrait s'agir d'une **valeur aberrante** ou, alternativement, un indicateur de **manque de vigilance des gardiens de but** au cours de cette période.

### Conclusion

Les analyses des scatterplots révèlent une tendance globale : les tirs à courte distance sont les plus susceptibles de se transformer en buts, tandis que les tirs lointains, bien que moins fréquents, peuvent devenir plus réussis lorsque certaines conditions, comme l'absence du gardien, sont présentes. L'évolution des stratégies défensives au fil des saisons se reflète dans la réduction du nombre de buts à courte distance, tandis que des schémas plus uniformes apparaissent pour les tirs de longue distance.

## 4.3 Analyse combinée des types de tirs et de la distance

### Objectif

L'objectif de cette analyse est de combiner les informations précédemment collectées pour produire un graphique représentant le pourcentage de buts (nombre de buts/nombre de tirs) en fonction de la distance au filet et du type de tir. Nous avons choisi de concentrer cette étude sur la saison 2020-2021.

### Méthodologie

Pour visualiser la relation entre le pourcentage de buts et la distance au filet, tout en tenant compte des différents types de tirs, nous avons opté pour un **scatterplot**. Ce graphique regroupe les données par distance et type de tir, permettant ainsi une analyse détaillée de l'efficacité de chaque type de tir à différentes distances.

### Analyse des résultats

Le graphique ci-dessous [Figure 14](#figure-14) montre le pourcentage de buts par type de tir en fonction de la distance pour la saison 2020-2021 :

![Pourcentage de buts par distance et type de tir](public/images/scatterplot_buts_par_type.png)
<figcaption id="figure-14">_Figure 14 : Scatterplot :  pourcentage de buts par type de tir en fonction de la distance 2020-2021_</figcaption>



### Observations
En observant ce graphique, plusieurs conclusions peuvent être tirées :

- **Types de tirs les plus efficaces** : Les tirs de type **'backhand'** et **'deflected'** présentent les plus hauts pourcentages de réussite, notamment à courte distance. Leur distribution occupe la partie supérieure de l'axe des y, indiquant un taux de conversion élevé en buts sur des distances proches du but.
  
- **Efficacité à différentes distances** : Nous avons classé les types de tirs selon leur efficacité par tranche de distance. Voici les principales conclusions :
  - Pour les courtes distances (entre 0 et 30 pieds), les tirs de type **'slap'** apparaissent comme les plus efficaces.
  - Entre 30 et 60 pieds, le **'wrap-around'** se distingue par un pourcentage de réussite supérieur.
  - Sur les distances supérieures à 60 pieds, le **'backhand'** reste le tir le plus dangereux, excepté pour les distances extrêmes (150 à 180 pieds), où le **'snap'** domine en termes de succès.
  
  À noter que sur les très longues distances, seuls quelques types de tirs sont tentés, et leur fréquence est relativement faible (par exemple, **'wrist'**, **'snap'**, **'slap'**, et **'backhand'**).

Nous avons aussi choisi une autre alternative [Figure 15](#figure-15) de visualiser les pourcentages de buts via des  graphiques de type KDE pour les différents types de tirs en fonction de la distance. 

![KDE](public/images/scatterplot_buts_par_type_1.png)

<figcaption id="figure-15">_Figure 15 : KDE : Diagramme de densité du pourcentage de buts vs distance par type de tir (2020-2021)_</figcaption>

**1.Wrist :**
La majorité des tirs réussis sont réalisés à courte distance, principalement entre 0 et 50 pieds. On voit un pourcentage de réussite relativement constant autour de 20 % à 60 % dans cette gamme de distances.
Au-delà de 50 pieds, il semble y avoir beaucoup moins de tentatives et les réussites diminuent considérablement.

**2.Deflected Shots (deflected) :**
Les tirs déviés montrent une concentration élevée de réussites à très courte distance (moins de 50 pieds), avec un pic de réussite autour de 20 % à 40 %.
Il y a une forte concentration de réussites très proches du but, ce qui est typique pour les tirs déviés.

**3.Backhand :**
Les backhands semblent avoir lieu presque exclusivement à des distances inférieures à 50 pieds, avec une répartition assez dense de réussites dans cette zone.Ce type de tir est beaucoup moins fréquent à longue distance.

**4.Tip-in :**
Comme prévu, les "tip-ins" sont principalement des tirs effectués à très courte distance, presque tous dans la zone de 0 à 50 pieds, avec un pourcentage de réussite souvent supérieur à 20 %.
Le graphique montre également une concentration importante de réussites dans cette petite plage de distance.

**5.Snap :**
Les "snap shots" montrent une distribution assez similaire à celle des wrist, avec une majorité des réussites dans la gamme de 0 à 50 pieds.
On observe une concentration importante de pourcentages de réussites variant de 20 % à 60 % dans cette zone.

**6.Wrap-around :**
Les "wrap-arounds" sont réalisés très près du but, avec une concentration de distances très courte (moins de 50 pieds).
Ces tirs semblent avoir un pourcentage de réussite plus élevé à très courte distance, ce qui est logique pour ce type de tir.

**7.Slap :**
Les slap shots montrent une plus grande variation dans les distances, avec des réussites visibles jusqu'à environ 100 pieds. Cependant, la majorité des réussites se trouvent toujours dans la zone de 0 à 50 pieds.
Le pourcentage de réussite diminue progressivement avec l'augmentation de la distance, ce qui est attendu étant donné que les slap shots sont généralement plus puissants mais moins précis à grande distance.


### Analyse des types de tirs les moins efficaces

De manière similaire, nous avons identifié les types de tirs ayant les pourcentages de réussite les plus faibles par tranche de distance  [Figure 16](#figure-16). Les résultats sont les suivants :

- Pour les distances intermédiaires (entre 60 et 90 pieds), le **'slap'** est le tir le moins efficace en moyenne.
- Pour les autres distances, le **'wrist'** s'avère être le moins performant, avec un taux de conversion en buts relativement bas.

![Observation1](public/images/observation_1.png)

![Observation2](public/images/observation_2.png)

<figcaption id="figure-16">_Figure 16 : Types de tirs avec les plus faibles pourcentages de réussite par tranche de distance_</figcaption>

### Conclusion

Cette analyse révèle que l'efficacité des tirs varie non seulement en fonction de la distance au but, mais également selon le type de tir. Les résultats obtenus permettent de mieux comprendre les stratégies de jeu et d'optimiser les choix de tirs selon la position sur la patinoire.

Les insights tirés de cette étude peuvent être particulièrement utiles pour les entraîneurs et les analystes sportifs afin de développer des stratégies adaptées aux forces et faiblesses de chaque équipe, et pour maximiser les chances de marquer à partir de différentes zones de la patinoire.

## 5:  Visualisations avancées des données
### Fonctionnalité interactive
Nous avons enrichi notre graphique interactif en ajoutant une **sélection de saison** en plus de la comparaison par équipe (via un **dropdown**). Cette extension permet de mieux observer l’évolution des stratégies de tir à travers plusieurs saisons. Voici un exemple représentatif :



{% include Interactive_plot.html %}

```markdown
{% raw %}
{% include [Visualisation des zones de tir: fréquence des tirs (zones chaudes et froides)].html %}
{% endraw %} 
```
_Visualisation des zones de tir: fréquence des tirs (zones chaudes et froides)_

Ces visualisations permettent de détecter **zones chaudes et froides** dans les cartes de tirs des équipes. 
- **Zones rouges** : Indiquent une fréquence de tirs supérieure à la moyenne de la ligue.  
- **Zones bleues** : Indiquent une fréquence de tirs inférieure à la moyenne.  

Ces cartes offrent une perspective comparative précieuse : en comparant les zones de tir entre plusieurs équipes, nous pouvons identifier des **différences stratégiques**, par exemple si une équipe privilégie les tirs proches du filet ou si elle préfère des tirs plus éloignés.

### 1. Étude de l’Avalanche du Colorado : 2016-17 vs 2020-21

Nous avons examiné les cartes de tirs de l’Avalanche du Colorado pour les saisons 2016-2017 et 2020-2021 afin d’identifier l'évolution de leur stratégie offensive.

#### Saison 2016-17

1. **Zones de tir préférentielles**  
   - La carte montre une forte concentration de tirs dans la **partie supérieure de la zone offensive**.  
   - Les zones de tir sont dispersées, avec peu de tirs proches du filet.  

2. **Impact potentiel sur la performance**  
   - Les tirs lointains réduisent la probabilité de marquer, facilitant l’arrêt pour le gardien adverse.  
   - Cette dispersion peut refléter une stratégie défensive prudente ou un manque de joueurs capables de s’infiltrer près du filet.  

#### Saison 2020-21

1. **Évolution vers des tirs plus proches du filet**  
   - On observe une densité accrue de tirs près du but, reflétant une stratégie plus agressive en zone offensive.  
   - L’équipe semble mieux pénétrer la zone défensive adverse, augmentant ainsi ses chances de marquer.  

2. **Amélioration de la performance offensive**  
   - Les tirs rapprochés sont plus efficaces, ce qui peut expliquer l’amélioration du classement de l’Avalanche en 2020-21.  
   - Cette évolution peut résulter de changements tactiques ou de l’arrivée de joueurs capables de jouer dans les espaces restreints près du filet.

#### Conclusion  
Cette comparaison révèle une progression significative de la stratégie offensive de l’Avalanche. En 2016-17, les tirs étaient dispersés et souvent éloignés du filet, ce qui limitait leur efficacité. En 2020-21, l’équipe semble se concentrer davantage sur les tirs rapprochés, augmentant ainsi leur taux de conversion en buts. Cette évolution est cohérente avec leur montée en puissance dans les classements depuis 2017.

### 2. Comparaison : Sabres de Buffalo vs Lightning de Tampa Bay (2018-21)

Nous avons également comparé les cartes de tir des Sabres de Buffalo, une équipe en difficulté, et du Lightning de Tampa Bay, vainqueur de deux Coupes Stanley consécutives, pour les saisons 2018-19, 2019-20 et 2020-21.

#### Sabres de Buffalo

- **Saison 2018-19**  

  - Les tirs sont relativement concentrés dans la zone centrale offensive, mais les zones de chaleur sont dispersées et peu intenses.  
  - Cela peut indiquer une **stratégie de tir inefficace**, avec peu de concentration dans les zones clés pour marquer.

- **Saison 2019-20** 

  - Une légère amélioration est observée avec plus de tirs devant le filet, mais la densité reste faible par rapport au Lightning.  
  - L’équipe semble avoir des difficultés à maintenir une pression offensive constante.

- **Saison 2020-21**  

  - La situation reste inchangée, avec des zones de chaleur modérées et dispersées. Cette régularité témoigne d’un manque de progression offensive notable.

#### Lightning de Tampa Bay

- **Saison 2018-19**  

  - Le Lightning montre une **forte concentration de tirs dans l’enclave**, juste devant le filet. Cette stratégie efficace contribue sans doute à leurs succès.

- **Saison 2019-20** 


  - La cohérence dans leurs zones de tir se renforce avec une densité encore plus élevée de tirs dans les positions clés.  

- **Saison 2020-21**  

  - La concentration des tirs augmente encore, particulièrement près du filet et sur le côté droit, indiquant une pression offensive constante et bien organisée.

#### Analyse comparative

Les Sabres ont une **stratégie de tir dispersée**, avec moins de cohérence et de concentration dans les zones avantageuses. En revanche, le Lightning affiche une **constance dans ses tirs**, ciblant les positions privilégiées pour marquer. Cette différence dans les approches offensives peut expliquer, en partie, le succès du Lightning et les difficultés des Sabres.

---

### Limites de l’analyse

Bien que les cartes de tir fournissent des informations utiles sur les tendances offensives des équipes, elles ne suffisent pas à expliquer entièrement le succès ou les difficultés d’une équipe. **D’autres facteurs** doivent être pris en compte, tels que :
- La qualité défensive.
- Les performances individuelles des joueurs.
- La cohésion d’équipe.
- La stratégie globale de jeu.

Ces visualisations doivent donc être interprétées dans un **contexte plus large** pour une compréhension complète de la performance des équipes.
